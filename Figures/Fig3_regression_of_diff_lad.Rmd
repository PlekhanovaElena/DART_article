
---
title: "Examples of absorptance in mixtures and monocultures"
author: "Elena Plekhanova"
date: "`r format(Sys.time(), '%B %e, %Y')`"
output:
  html_notebook:
    code_folding: hide
  pdf_document: default
fontsize: 16pt
---

<style type="text/css">

body{ /* Normal  */
      font-size: 18px;
  }
td {  /* Table  */
  font-size: 10px;
}
h1.title {
  font-size: 32px;
  color: DarkRed;
}

h1.subtitle {
  font-size: 32px;
  color: DarkRed;
}

h1 { /* Header 1 */
  font-size: 32px;
  color: DarkRed;
}
h2 { /* Header 2 */
    font-size: 25px;
  color: DarkRed;
}
h3 { /* Header 3 */
  font-size: 22px;
  font-family: "Times New Roman", Times, serif;
  color: DarkRed;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>

&nbsp;

```{r}
library(ggplot2)
library(gridExtra)
library(viridis)

diff_betw_sp_in_mix_and_in_mon = function(subdat, Nscenes_loc = Nscenes, Nspecies_loc = Nspecies) {
 
  subdat_crown = as.data.frame(subdat[subdat$height_m != 1,])

  aggdat = aggregate(abs_mean ~ height_m + pos + num_of_species + scenetype + species, data = subdat_crown, FUN = "mean")
  aggdat = aggregate(abs_mean ~ pos + num_of_species + scenetype + species, data = aggdat, FUN = "sum")
  
  mix_tab = lapply(unique(aggdat$scenetype), function(SCTYPE) {
    res_tab = lapply(unique(aggdat$pos[as.numeric(aggdat$num_of_species) > 1]), function(POS) {

      av_mix = subset(aggdat, pos == POS & scenetype == SCTYPE)
      sps = unique(av_mix$species)
      av_mix_sp1 = av_mix$abs_mean[av_mix$species == sps[1]]
      av_mix_sp2 = av_mix$abs_mean[av_mix$species == sps[2]]
      av_mon_sp1 = subset(aggdat, species == sps[1] & scenetype == SCTYPE & num_of_species == 1)$abs_mean
      av_mon_sp2 = subset(aggdat, species == sps[2] & scenetype == SCTYPE & num_of_species == 1)$abs_mean

      one_mix = data.frame(cbind(c((av_mix_sp1 - av_mon_sp1)[1], (av_mix_sp2 - av_mon_sp2)[1]), 
                                 c(av_mon_sp1, av_mon_sp2),
                                 c(1, 0),
                                 rep(POS, 2) ))
      
      colnames(one_mix) = c("abs_mean", "mon_abs", "sp_a" ,"pos")
      one_mix$diff_mon = (av_mon_sp1 - av_mon_sp2)[1] ## difference in absorbtion of monocultures
      one_mix$diff_mix = (av_mix_sp1 - av_mix_sp2)[1] ## difference in absorbtion of mixtures
      one_mix$species = sps
      one_mix$name_species = paste0(sps[1], " + ", sps[2])
      
      return(one_mix)
    })
    res_tab = do.call(rbind.data.frame, res_tab)
    res_tab$scenetype = SCTYPE
    return(res_tab)
  })
  mix_tab = do.call(rbind.data.frame, mix_tab)
  
  return(mix_tab)
}


read_profiles = function(trait_loc = trait, WAVE_RANGE_loc = WAVE_RANGE, sun_angle_30_loc = sun_angle_30) {
  
  angle = ""
  if (sun_angle_30_loc) angle = "_30"
  
  dat = read.csv(
    #paste0("C:/Users/Gast/DART/user_data/simulations/Output_data/",trait_loc,"6_abs_90_db/profiles", angle, ".csv"))
    "C:/Users/Gast/DART/user_data/simulations/Output_data/lad6_abs_overcast_db/profiles.csv")
 # dat = read.csv("C:/Users/Gast/DART/user_data/simulations/Output_data/lop6_abs_90_db/reflect.csv")
  
  dat$num_of_species = as.factor(dat$num_of_species)
  dat$species = as.factor(dat$species)
  if (trait_loc == "lad") {
    levels(dat$species) = c("Spherical", "Uniform", "Vertical", "Horizontal", "Ellipsoidal", "Extremophile")
  } else
    levels(dat$species) = c("beech", "deciduous", "elm", "eucalyptus", "aspen", "pine")
  
  subdat = dat[dat$band == WAVE_RANGE_loc,]
}
```



```{r}
Ncomb = 63
Nscenes = 3
Nspecies = 6
WAVE_RANGE = "VIS"
trait = "lad"
sun_angle_30 = F
```


```{r}
cumsumm = cumsum(unlist(sapply(c(1:Nspecies), function(x) choose(Nspecies, x))))
the_list_of_comb = sapply(c(1:Nspecies), function(k) sapply(c(1:choose(Nspecies, k)), function(i) combn(Nspecies, k)[,i]))
the_list_of_sp = unlist(sapply(c(2:Nspecies), function(j) { x = the_list_of_comb[[j]]
  res = split(x, rep(1:ncol(x), each = nrow(x)))
  return(res)}), recursive = FALSE)
the_list_of_sp = append(sapply(c(1:Nspecies), function(x) list(x)), the_list_of_sp)
names(the_list_of_sp) = c(1:63)

```


## Leaf optical properties


```{r fig.height=7, fig.width=12}
subdat = read_profiles(trait = trait)
#sp_of_interest = subset(subdat, height_m != 1 & pos %in% c(3,4,16))
#sp_of_interest = subset(subdat, height_m != 1 & pos %in% c(1,3,8))
sp_of_interest = subset(subdat, height_m != 1 & num_of_species %in% c(1,2), select = c("num_of_species", "species", "pos", "scenetype", "height_m", "abs_mean"))


sp_of_interest$scenetype = as.factor(sp_of_interest$scenetype)
levels(sp_of_interest$scenetype) = c("white", "black", "natural")


whbl_subdat = merge(sp_of_interest[sp_of_interest$scenetype == "white",], 
                    sp_of_interest[sp_of_interest$scenetype == "black",], 
                      by = c("num_of_species", "species", "pos", "height_m"))
whbl_subdat$abs_mean = whbl_subdat$abs_mean.x - whbl_subdat$abs_mean.y
whbl_subdat$scenetype = "white - black"
whbl_subdat = subset(whbl_subdat, select = c("num_of_species", "species", "pos", "scenetype", "height_m", "abs_mean"))

sp_of_interest = as.data.frame(rbind(sp_of_interest, whbl_subdat))
sp_of_interest$scenetype = factor(sp_of_interest$scenetype,c("white", "black", "white - black", "natural"))

sp_of_interest$pos = as.factor(sp_of_interest$pos)
#levels(sp_of_interest$pos) = c("mon", "mon", "mix")
```

Excluding vertical
```{r}
#vertical_pos = sapply(unique(sp_of_interest$pos), function(x) sum(sp_of_interest$species[sp_of_interest$pos == x] == "Vertical") > 0)
#sp_of_interest = sp_of_interest[sp_of_interest$pos %in% unique(sp_of_interest$pos)[!vertical_pos],]

#subdat$species = droplevels(subdat$species)
```


```{r fig.height=7, fig.width=12}
ggplot(data = sp_of_interest, 
       aes(x = height_m, y = abs_mean, col = interaction(num_of_species, species), group = interaction(pos, species))) +
  geom_line(size = 1.2) +
  ylab("proportion of absorbed light")  + theme_bw() + xlab("height, m") + 
  ggtitle("type of background") + 
  scale_color_brewer(palette = "Paired",direction=-1, name = "Mon/Mix.Species") +
  coord_flip() +
  facet_grid(~scenetype, space = "free", scales = "free") + 
  scale_y_continuous(breaks = seq(0,0.14,0.05)) +
  theme(panel.grid.major = element_line(colour = "lightgrey"), panel.grid.minor.y = element_blank(),
        plot.title = element_text(size=16, hjust = 0.5),
        axis.title.x = element_text(size=16), axis.text.x  = element_text(size=12),
        axis.title.y = element_text(size=16), axis.text.y  = element_text(size=12),
        strip.text.x = element_text(size = 14), strip.text.y = element_text(size = 14),
        legend.text = element_text(size=12), legend.title = element_text(size=14), title = element_text(size=16))
```


```{r fig.height=7, fig.width=12}
subdat = read_profiles(trait = trait)
sp_of_interest = subset(subdat, height_m != 1 & num_of_species %in% c(1,2), select = c("num_of_species", "species", "pos", "scenetype", "height_m", "abs_mean"))


sp_of_interest$scenetype = as.factor(sp_of_interest$scenetype)
levels(sp_of_interest$scenetype) = c("white", "black", "natural")


whbl_subdat = merge(sp_of_interest[sp_of_interest$scenetype == "white",], 
                    sp_of_interest[sp_of_interest$scenetype == "black",], 
                      by = c("num_of_species", "species", "pos", "height_m"))
whbl_subdat$abs_mean = whbl_subdat$abs_mean.x - whbl_subdat$abs_mean.y
whbl_subdat$scenetype = "white - black"
whbl_subdat = subset(whbl_subdat, select = c("num_of_species", "species", "pos", "scenetype", "height_m", "abs_mean"))

sp_of_interest = as.data.frame(rbind(sp_of_interest, whbl_subdat))
sp_of_interest$scenetype = factor(sp_of_interest$scenetype,c("white", "black", "white - black", "natural"))
#mix_tab = diff_betw_sp_in_mix_and_in_mon(sp_of_interest)

```

Excluding vertical
```{r}
#vertical_pos = sapply(unique(sp_of_interest$pos), function(x) sum(sp_of_interest$species[sp_of_interest$pos == x] == "Vertical") > 0)
#sp_of_interest = sp_of_interest[sp_of_interest$pos %in% unique(sp_of_interest$pos)[!vertical_pos],]

#sp_of_interest$species = droplevels(sp_of_interest$species)
```

### Difference in absorptance

```{r fig.height=8, fig.width=14}
mix_tab = diff_betw_sp_in_mix_and_in_mon(sp_of_interest)
ggplot(data = mix_tab, 
       aes(x = pos, y = abs_mean, col = as.factor(species), group = as.factor(pos))) +
  geom_point(size = 2.5) + geom_hline(aes(yintercept = 0), col = "gray8") + geom_segment(aes(x=pos, xend=pos, y=0, yend=abs_mean )) +
  ylab("difference in mixtures minus monocultures")  + theme_bw() + xlab("different mixtures") + 
  ggtitle("type of background") + 
  #scale_color_viridis(option="inferno") +
  coord_flip() +
  scale_color_brewer(palette = "Dark2") +
  facet_grid(~scenetype, space = "free", scales = "free") + 
  scale_y_continuous(breaks = seq(-1,0.15,0.05)) +
  #scale_y_continuous(breaks = seq(-1,1,0.2)) +
  theme(panel.grid.major = element_line(colour = "lightgrey"), panel.grid.minor.y = element_blank(), 
        panel.grid.major.y = element_blank(),
        plot.title = element_text(size=16, hjust = 0.5),
        axis.title.x = element_text(size=16), axis.text.x  = element_text(size=12),
        axis.title.y = element_text(size=16), axis.text.y  = element_blank(),
        strip.text.x = element_text(size = 14), strip.text.y = element_text(size = 14),
        legend.text = element_text(size=12), legend.title = element_text(size=14), title = element_text(size=16))
```

```{r fig.height=7, fig.width=12}

mix_tab = diff_betw_sp_in_mix_and_in_mon(sp_of_interest)
ggplot(data = mix_tab, 
       aes(x = diff_mon, y = diff_mix, col = as.factor(name_species), group = as.factor(pos)) ) +
  geom_point() + geom_line() +
  geom_hline(aes(yintercept = 0), col = "gray35") +
  ylab("abs_ab_a - abs_ab_b")  + theme_bw() + xlab("abs_a - abs_b") + 
  ggtitle("type of background") + 
  #coord_flip() +
  facet_grid(~scenetype) + 
  scale_x_continuous(breaks = seq(-1,1,0.05)) +
  theme(panel.grid.major = element_line(colour = "lightgrey"), panel.grid.minor.y = element_blank(), 
        #panel.grid.major.y = element_blank(),
        plot.title = element_text(size=16, hjust = 0.5),
        axis.title.x = element_text(size=16), axis.text.x  = element_text(size=12),
        axis.title.y = element_text(size=16), axis.text.y  = element_text(size=12),
        strip.text.x = element_text(size = 14), strip.text.y = element_text(size = 14),
        legend.text = element_text(size=12), legend.title = element_text(size=14), title = element_text(size=16))
```
```{r fig.height=5, fig.width=10}
ab_mixtab = mix_tab
ab_mixtab$diff_mon[ab_mixtab$sp_a == 0] = - ab_mixtab$diff_mon[ab_mixtab$sp_a == 0]
ggplot(data = ab_mixtab, 
       aes(x = diff_mon, y = abs_mean, col = as.factor(species), group = as.factor(pos)) ) +
  geom_line(col = "lightgrey") + geom_point(size = 1.5)  +
  #geom_hline(aes(yintercept = 0), col = "gray35") +
  ylab("gain_a")  + theme_bw() + xlab("abs_a - abs_b") + 
  ggtitle("type of background") + 
  #coord_flip() +
  facet_grid(~scenetype) + 
  #scale_x_continuous(breaks = seq(-1,1,0.05)) +
  theme(panel.grid.major = element_line(colour = "lightgrey"), panel.grid.minor.y = element_blank(), 
        #panel.grid.major.y = element_blank(),
        plot.title = element_text(size=16, hjust = 0.5),
        axis.title.x = element_text(size=16), axis.text.x  = element_text(size=12),
        axis.title.y = element_text(size=16), axis.text.y  = element_text(size=12),
        strip.text.x = element_text(size = 14), strip.text.y = element_text(size = 14),
        legend.text = element_text(size=12), legend.title = element_text(size=14), title = element_text(size=16))
```


```{r}
head(mix_tab)
mix_tab$sp_a = sapply(c(1:nrow(mix_tab)), function(x) ifelse(mix_tab$mon_abs[i] > mix_tab$mon_abs[i+1], 1, 0))
```


```{r fig.height=8, fig.width=14}
ggplot(data = mix_tab, 
       aes(x = mon_abs, y = abs_mean, col = as.factor(name_species), group = as.factor(pos)) ) +
  geom_point() + geom_line() +
  geom_hline(aes(yintercept = 0), col = "gray35") +
  ylab("rence in mixtures minus monocultures")  + theme_bw() + xlab("absorptance in monoculture") + 
  ggtitle("type of background") + 
  coord_flip() +
  facet_grid(~scenetype, space = "free", scales = "free") + 
  scale_y_continuous(breaks = seq(-1,0.15,0.05)) +
  theme(panel.grid.major = element_line(colour = "lightgrey"), panel.grid.minor.y = element_blank(), 
        #panel.grid.major.y = element_blank(),
        plot.title = element_text(size=16, hjust = 0.5),
        axis.title.x = element_text(size=16), axis.text.x  = element_text(size=12),
        axis.title.y = element_text(size=16), axis.text.y  = element_text(size=12),
        strip.text.x = element_text(size = 14), strip.text.y = element_text(size = 14),
        legend.text = element_text(size=12), legend.title = element_text(size=14), title = element_text(size=16))
```
```{r}
head(mix_tab)
```

```{r}
tab_scene = subset(mix_tab, scenetype == "white")
cor.test(tab_scene$diff_mon, tab_scene$diff_mix)
```

```{r}
tab_scene = subset(mix_tab, scenetype == "white")
cor.test(tab_scene$abs_mean, tab_scene$mon_abs)
```


```{r fig.height=7, fig.width=12}
subdat = read_profiles(trait = "lop")
mix_tab = diff_betw_mix_and_av_of_mon(subdat)

ggplot(data = mix_tab, 
       aes(x = height_m, y = abs_mean, col = diff_sum, group = as.factor(pos))) +
  geom_line(size = 1) +
  ylab("proportion of absorbed light")  + theme_bw() + xlab("height, m") + 
  ggtitle("type of background") + 
  scale_color_viridis(option="inferno") +
  coord_flip() +
  facet_grid(~scenetype, space = "free", scales = "free") + 
  scale_y_continuous(breaks = seq(0,0.15,0.002)) +
  theme(panel.grid.major = element_line(colour = "lightgrey"), panel.grid.minor.y = element_blank(),
        plot.title = element_text(size=16, hjust = 0.5),
        axis.title.x = element_text(size=16), axis.text.x  = element_text(size=12),
        axis.title.y = element_text(size=16), axis.text.y  = element_text(size=12),
        strip.text.x = element_text(size = 14), strip.text.y = element_text(size = 14),
        legend.text = element_text(size=12), legend.title = element_text(size=14), title = element_text(size=16))

```
